import logger from '@wdio/logger';
import { setPort } from './client.js';
const log = logger('@wdio/shared-store-service');
let server;
export default class SharedStoreLauncher {
    _app;
    async onPrepare(_, capabilities) {
        /**
         * import during runtime to avoid unnecessary dependency loading
         */
        server = (await import('./server.js'));
        const { port, app } = await server.startServer();
        this._app = app;
        setPort(port);
        capabilities.forEach((capability) => {
            capability['wdio:sharedStoreServicePort'] = port;
        });
        log.info(`Started shared server on port ${port}`);
    }
    async onComplete() {
        return new Promise((resolve) => {
            if (this._app && this._app.server.close) {
                this._app.server.close(() => resolve());
            }
            return resolve();
        });
    }
}
